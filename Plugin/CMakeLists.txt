CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(AlembicForUnity)

SET(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake)
FIND_PACKAGE(OpenEXR QUIET)
FIND_PACKAGE(HDF5 QUIET)
FIND_PACKAGE(Alembic QUIET)

SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fPIC")
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -std=c++11")

IF(CMAKE_SYSTEM_NAME STREQUAL "Linux")
ELSEIF(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    OPTION(ABCI_ENABLE_OSX_BUNDLE "Build bundle." OFF)
    SET(CMAKE_MACOSX_RPATH ON)

    IF(ABCI_ENABLE_OSX_BUNDLE)
        SET(CMAKE_SKIP_RPATH ON)
    ELSE()
        SET(CMAKE_SKIP_RPATH OFF)
    ENDIF()
ENDIF()

SET(ASSETS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../AlembicImporter/Assets")
SET(PLUGINS_DIR "${ASSETS_DIR}/UTJ/Plugins/x86_64")

INCLUDE_DIRECTORIES(
    .
    ${OPENEXR_INCLUDE_DIRS}
    ${ALEMBIC_INCLUDE_DIR}
)


# abci
FILE(GLOB ABCI_CXX_FILES abci/Importer/*.cpp abci/Exporter/*.cpp Foundation/*.cpp)
FILE(GLOB ABCI_H_FILES abci/Importer/*.h abci/Exporter/*.h Foundation/*.h)
IF(ABCI_ENABLE_OSX_BUNDLE)
    ADD_LIBRARY(abci MODULE ${ABCI_CXX_FILES} ${ABCI_H_FILES})
ELSE()
    ADD_LIBRARY(abci SHARED ${ABCI_CXX_FILES} ${ABCI_H_FILES})
ENDIF()
TARGET_INCLUDE_DIRECTORIES(abci PUBLIC ./abci ./abci/Foundation)
TARGET_LINK_LIBRARIES(abci
    ${OPENEXR_Half_LIBRARY}
    ${OPENEXR_Iex_LIBRARY}
    ${OPENEXR_IexMath_LIBRARY}
    ${HDF5_C_LIBRARIES}
    ${HDF5_HL_LIBRARIES}
    ${ALEMBIC_LIBRARY}
)


IF(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    IF(ABCI_ENABLE_OSX_BUNDLE)
        SET_TARGET_PROPERTIES(abci PROPERTIES BUNDLE ON)
    ELSE()
        SET_TARGET_PROPERTIES(abci PROPERTIES PREFIX "")
        SET_TARGET_PROPERTIES(abci PROPERTIES SUFFIX ".bundle")
    ENDIF()
ENDIF()

IF(NOT ABCI_ENABLE_OSX_BUNDLE)
    # deploy
    ADD_CUSTOM_TARGET(deploy ALL
        COMMAND rm -rf ${PLUGINS_DIR}/$<TARGET_FILE_NAME:abci>
        COMMAND cp $<TARGET_FILE:abci> ${PLUGINS_DIR}
        DEPENDS abci
    )
ENDIF()
