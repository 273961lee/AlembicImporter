CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(AlembicForUnity)

SET(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake)
FIND_PACKAGE(OpenEXR QUIET)
FIND_PACKAGE(HDF5 QUIET)
FIND_PACKAGE(Alembic QUIET)

SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fPIC")
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -std=c++11")

IF(CMAKE_SYSTEM_NAME STREQUAL "Linux")
ELSEIF(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    OPTION(ABCI_ENABLE_OSX_BUNDLE "Build bundle." OFF)
    SET(CMAKE_MACOSX_RPATH ON)

    IF(ABCI_ENABLE_OSX_BUNDLE)
        SET(CMAKE_SKIP_RPATH ON)
    ELSE()
        SET(CMAKE_SKIP_RPATH OFF)
    ENDIF()
ENDIF()

SET(ASSETS_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../AlembicImporter/Assets")
SET(PLUGINS_DIR "${ASSETS_DIR}/UTJ/Plugins/x86_64")

INCLUDE_DIRECTORIES(
    .
    ${OPENEXR_INCLUDE_DIRS}
    ${ALEMBIC_INCLUDE_DIR}
)


# AlembicImporter
FILE(GLOB AI_CXX_FILES Importer/*.cpp Foundation/*.cpp)
FILE(GLOB AI_H_FILES Importer/*.h Foundation/*.h)
IF(ABCI_ENABLE_OSX_BUNDLE)
    ADD_LIBRARY(AlembicImporter MODULE ${AI_CXX_FILES} ${AI_H_FILES})
ELSE()
    ADD_LIBRARY(AlembicImporter SHARED ${AI_CXX_FILES} ${AI_H_FILES})
ENDIF()
TARGET_INCLUDE_DIRECTORIES(AlembicImporter PUBLIC ./Foundation)
TARGET_LINK_LIBRARIES(AlembicImporter
    ${OPENEXR_Half_LIBRARY}
    ${OPENEXR_Iex_LIBRARY}
    ${OPENEXR_IexMath_LIBRARY}
    ${HDF5_C_LIBRARIES}
    ${HDF5_HL_LIBRARIES}
    ${ALEMBIC_LIBRARY}
)


# AlembicExporter
FILE(GLOB AE_CXX_FILES Exporter/*.cpp Foundation/*.cpp)
FILE(GLOB AE_H_FILES Exporter/*.h Foundation/*.h)
IF(ABCI_ENABLE_OSX_BUNDLE)
    ADD_LIBRARY(AlembicExporter MODULE ${AE_CXX_FILES} ${AI_H_FILES})
ELSE()
    ADD_LIBRARY(AlembicExporter SHARED ${AE_CXX_FILES} ${AI_H_FILES})
ENDIF()
TARGET_INCLUDE_DIRECTORIES(AlembicExporter PUBLIC ./Foundation)
TARGET_LINK_LIBRARIES(AlembicExporter
    ${OPENEXR_Half_LIBRARY}
    ${OPENEXR_Iex_LIBRARY}
    ${OPENEXR_IexMath_LIBRARY}
    ${HDF5_C_LIBRARIES}
    ${HDF5_HL_LIBRARIES}
    ${ALEMBIC_LIBRARY}
)


IF(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    IF(ABCI_ENABLE_OSX_BUNDLE)
        SET_TARGET_PROPERTIES(AlembicImporter AlembicExporter PROPERTIES BUNDLE ON)
    ELSE()
        SET_TARGET_PROPERTIES(AlembicImporter AlembicExporter PROPERTIES PREFIX "")
        SET_TARGET_PROPERTIES(AlembicImporter AlembicExporter PROPERTIES SUFFIX ".bundle")
    ENDIF()
ENDIF()

IF(NOT ABCI_ENABLE_OSX_BUNDLE)
    # deploy
    ADD_CUSTOM_TARGET(deploy ALL
        COMMAND rm -rf ${PLUGINS_DIR}/$<TARGET_FILE_NAME:AlembicImporter>
        COMMAND rm -rf ${PLUGINS_DIR}/$<TARGET_FILE_NAME:AlembicExporter>
        COMMAND cp $<TARGET_FILE:AlembicImporter> ${PLUGINS_DIR}
        COMMAND cp $<TARGET_FILE:AlembicExporter> ${PLUGINS_DIR}
        DEPENDS AlembicImporter
        DEPENDS AlembicExporter
    )
ENDIF()
